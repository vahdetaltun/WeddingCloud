document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const popup = document.getElementById('popup');
  const closePopup = document.getElementById('closePopup');
  const formContainer = document.getElementById('form-container');
  const selectorButtons = document.querySelectorAll('.input-selector button');
  const textInputGroup = document.getElementById('textInputGroup');
  const audioInputGroup = document.getElementById('audioInputGroup');
  const imageInputGroup = document.getElementById('imageInputGroup');
  const videoInputGroup = document.getElementById('videoInputGroup');
  const form = document.getElementById('memoryForm');
  const loader = document.getElementById('loader');
  const statusMessage = document.getElementById('statusMessage');
  const recordButton = document.getElementById('recordButton');
  const stopButton = document.getElementById('stopButton');
  const audioPreview = document.getElementById('audioPreview');
  const audioDataInput = document.getElementById('audioData');
  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  const videoInput = document.getElementById('videoInput');
  const videoPreview = document.getElementById('videoPreview');
  const submitButton = document.getElementById('submitButton');
  const imageSelectionInfo = document.getElementById('imageSelectionInfo');
  const heartsContainer = document.getElementById('hearts-container');

  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-WHdbVQYWbKc60SEMbl_Q7v3YpLaz3t9Ao82DbyybbsBKBDXbkPyn5_Wqv9ETmniTKw/exec';
  const API_KEY = '12345ABC';
  const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
  const MAX_IMAGE_COUNT = 10; // Maksimum 10 resim
  const MAX_TOTAL_IMAGE_SIZE = 100 * 1024 * 1024; // Toplam 100MB

  let mediaRecorder;
  let audioChunks = [];
  let clientIP = "";

  let base64Images = [];
  let base64Videos = [];
  let totalImageSize = 0;
  let selectedFiles = []; // Se√ßilen dosyalarƒ± takip etmek i√ßin

  // Kalp animasyonu olu≈ütur
  function createHearts() {
    const heartEmojis = ['üíñ', 'üíï', 'üíó', 'üíì', 'üíû', 'üíò'];
    for (let i = 0; i < 15; i++) {
      const heart = document.createElement('div');
      heart.className = 'heart';
      heart.textContent = heartEmojis[Math.floor(Math.random() * heartEmojis.length)];
      heart.style.left = Math.random() * 100 + '%';
      heart.style.animationDelay = Math.random() * 5 + 's';
      heartsContainer.appendChild(heart);
    }
  }
  
  createHearts();

  // IP adresini al
  fetch("https://api64.ipify.org?format=json")
    .then(res => res.json())
    .then(data => { clientIP = data.ip; })
    .catch(() => { clientIP = "Bilinmiyor"; });

  // Toast bildirim fonksiyonu
  function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    toastContainer.appendChild(toast);
    
    // Toast'ƒ± g√∂ster
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Toast'ƒ± kaldƒ±r
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toastContainer.removeChild(toast), 300);
    }, 5000);
  }

  // Popup kapat, form g√∂ster
  closePopup.addEventListener('click', function() {
    popup.style.display = 'none';
    formContainer.style.display = 'block';
    showToast("Anƒ± defterimize ho≈ü geldiniz! üíï", "info");
  });

  // ƒ∞sim doƒürulama fonksiyonu
  function isValidName(name) {
    // Sadece nokta, virg√ºl, tire gibi karakterlerden olu≈üan isimleri engelle
    const invalidPattern = /^[.,\-_\s]+$/;
    // En az 2 karakter ve ge√ßerli harfler/kelimeler i√ßermeli
    const validPattern = /^[a-zA-Z√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú\s]{2,}$/;
    
    return !invalidPattern.test(name) && validPattern.test(name);
  }

  // T√ºr se√ßici butonlar
  selectorButtons.forEach(button => {
    button.addEventListener('click', function() {
      selectorButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');

      const type = this.dataset.type;
      textInputGroup.style.display = type === 'text' ? 'block' : 'none';
      audioInputGroup.style.display = type === 'audio' ? 'block' : 'none';
      imageInputGroup.style.display = type === 'image' ? 'block' : 'none';
      videoInputGroup.style.display = type === 'video' ? 'block' : 'none';

      hideStatus();
      
      // T√ºr deƒüi≈ütiƒüinde bildirim g√∂ster
      const typeNames = {
        text: "Metin mesajƒ±",
        audio: "Ses kaydƒ±",
        image: "Fotoƒüraf",
        video: "Video"
      };
      showToast(`${typeNames[type]} payla≈üƒ±mƒ± se√ßildi. ‚ú®`, "info");
    });
  });

  // √áoklu resim se√ßimi ve √∂nizleme
  imageInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    base64Images = [];
    selectedFiles = [];
    totalImageSize = 0;
    imagePreview.innerHTML = '';
    imageSelectionInfo.style.display = 'none';

    if (files.length === 0) return;

    // Dosya sayƒ±sƒ± kontrol√º
    if (files.length > MAX_IMAGE_COUNT) {
      showToast(`En fazla ${MAX_IMAGE_COUNT} fotoƒüraf se√ßebilirsiniz. ‚ùå`, "error");
      this.value = '';
      return;
    }

    // Toplam boyut kontrol√º
    const totalSize = files.reduce((total, file) => total + file.size, 0);
    if (totalSize > MAX_TOTAL_IMAGE_SIZE) {
      showToast("Toplam dosya boyutu 100MB sƒ±nƒ±rƒ±nƒ± a≈üƒ±yor. ‚ùå", "error");
      this.value = '';
      return;
    }

    // Dosya boyutu kontrol√º
    const oversizedFiles = files.filter(file => file.size > MAX_FILE_SIZE);
    if (oversizedFiles.length > 0) {
      showToast("Bazƒ± dosyalar 100MB sƒ±nƒ±rƒ±ndan b√ºy√ºk. ‚ùå", "error");
      this.value = '';
      return;
    }

    // Se√ßim bilgisini g√∂ster
    imageSelectionInfo.style.display = 'block';
    imageSelectionInfo.innerHTML = `üìä ${files.length} fotoƒüraf se√ßildi - Toplam: ${formatFileSize(totalSize)}`;

    // Dosyalarƒ± i≈üle
    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(event) {
        const base64Data = event.target.result;
        base64Images.push(base64Data);
        selectedFiles.push({
          base64: base64Data,
          size: file.size,
          name: file.name
        });
        totalImageSize += file.size;

        // Dosya bilgisi ve √∂nizleme g√∂ster
        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        fileInfo.dataset.index = index;
        fileInfo.innerHTML = `
          <div class="file-preview-with-image">
            <img src="${base64Data}" class="file-preview-image" alt="${file.name}">
            <div class="file-details">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
          <button type="button" class="remove-file" data-index="${index}">√ó</button>
        `;
        imagePreview.appendChild(fileInfo);
        
        // Kaldƒ±rma butonuna olay dinleyici ekle
        const removeBtn = fileInfo.querySelector('.remove-file');
        removeBtn.addEventListener('click', function() {
          removeImage(this.dataset.index, file.size);
        });
      };
      reader.readAsDataURL(file);
    });
    
    if (files.length > 0) {
      showToast(`${files.length} fotoƒüraf se√ßildi. üì∏`, "success");
    }
  });

  // Resim kaldƒ±rma fonksiyonu
  function removeImage(index, size) {
    // Dizilerden ilgili √∂ƒüeyi kaldƒ±r
    base64Images.splice(index, 1);
    selectedFiles.splice(index, 1);
    
    // DOM'dan kaldƒ±r
    const fileElement = document.querySelector(`.file-info[data-index="${index}"]`);
    if (fileElement) {
      fileElement.remove();
    }
    
    // T√ºm dosya elementlerinin index'lerini g√ºncelle
    const fileElements = document.querySelectorAll('.file-info');
    fileElements.forEach((element, i) => {
      element.dataset.index = i;
      const removeBtn = element.querySelector('.remove-file');
      removeBtn.dataset.index = i;
    });
    
    // Toplam boyutu g√ºncelle
    totalImageSize -= size;
    
    // Se√ßili dosya sayƒ±sƒ±nƒ± g√ºncelle
    const remainingImages = imagePreview.querySelectorAll('.file-info').length;
    
    if (remainingImages === 0) {
      imageSelectionInfo.style.display = 'none';
      base64Images = [];
      selectedFiles = [];
    } else {
      imageSelectionInfo.innerHTML = `üìä ${remainingImages} fotoƒüraf se√ßildi - Toplam: ${formatFileSize(totalImageSize)}`;
    }
    
    showToast("Fotoƒüraf kaldƒ±rƒ±ldƒ±. ‚ùå", "info");
  }

  // Video se√ßim i≈ülemi - D√úZELTƒ∞LMƒ∞≈û VERSƒ∞YON
  videoInput.addEventListener('change', function(e) {
    handleVideoSelection(e.target.files[0]);
  });

  // Video se√ßim i≈ülemini fonksiyona ayƒ±r
  function handleVideoSelection(file) {
    base64Videos = []; // Her seferinde array'ƒ± temizle
    videoPreview.innerHTML = '';

    if (!file) return;

    // Dosya boyutu kontrol√º
    if (file.size > MAX_FILE_SIZE) {
      showToast("Video 100MB sƒ±nƒ±rƒ±ndan b√ºy√ºk. Daha k√º√ß√ºk bir video se√ßin. ‚ùå", "error");
      videoInput.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
      const base64Data = event.target.result;
      base64Videos.push(base64Data);
      createVideoPreview(base64Data, file);
    };
    reader.readAsDataURL(file);
    
    showToast("Video se√ßildi. üé¨", "success");
  }

  // Video √∂nizleme olu≈ütur
  function createVideoPreview(base64Data, file) {
    const videoElement = document.createElement('video');
    videoElement.controls = true;
    videoElement.style.maxWidth = '100%';
    videoElement.style.borderRadius = '8px';
    videoElement.style.marginTop = '15px';
    
    const source = document.createElement('source');
    source.src = base64Data;
    source.type = file.type;
    videoElement.appendChild(source);

    const fileInfo = document.createElement('div');
    fileInfo.className = 'file-info';
    fileInfo.innerHTML = `
      <div class="file-preview-with-image">
        <div style="width:60px; height:60px; display:flex; align-items:center; justify-content:center; background:#f0f0f0; border-radius:8px;">
          <span style="font-size:24px;">üé•</span>
        </div>
        <div class="file-details">
          <div class="file-name">${file.name}</div>
          <div class="file-size">${formatFileSize(file.size)}</div>
        </div>
      </div>
      <button type="button" class="remove-file" onclick="removeVideo()">√ó</button>
    `;
    
    videoPreview.appendChild(fileInfo);
    videoPreview.appendChild(videoElement);
  }

  // Video kaldƒ±rma fonksiyonu - YENƒ∞ EKLENDƒ∞
  window.removeVideo = function() {
    base64Videos = []; // Array'ƒ± temizle
    videoInput.value = ''; // Input'u sƒ±fƒ±rla
    videoPreview.innerHTML = ''; // √ñnizlemeyi temizle
    showToast("Video kaldƒ±rƒ±ldƒ±. ‚ùå", "info");
  };

  // Dosya boyutunu formatlama
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
  }

  // Ses kaydƒ± ba≈ülatma
  recordButton.addEventListener('click', async function() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Tarayƒ±cƒ±ya g√∂re uygun format se√ß
      let options = { mimeType: "audio/webm" }; // varsayƒ±lan
      if (MediaRecorder.isTypeSupported("audio/mp4")) options = { mimeType: "audio/mp4" }; // Safari / iOS
      else if (MediaRecorder.isTypeSupported("audio/wav")) options = { mimeType: "audio/wav" }; // diƒüer
      else if (MediaRecorder.isTypeSupported("audio/3gpp")) options = { mimeType: "audio/3gpp" }; // Android eski

      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];

      mediaRecorder.ondataavailable = function(e) {
        audioChunks.push(e.data);
      };

      mediaRecorder.onstop = function() {
        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPreview.src = audioUrl;
        audioPreview.style.display = 'block';

        const reader = new FileReader();
        reader.onloadend = function() {
          audioDataInput.value = reader.result; // Base64 olarak sakla
        };
        reader.readAsDataURL(audioBlob);
      };

      mediaRecorder.start();
      recordButton.disabled = true;
      stopButton.style.display = 'inline-block';
      showToast("Ses kaydƒ± ba≈üladƒ±... üé§", "info");
    } catch (err) {
      showToast("Mikrofona eri≈üim izni vermeniz gerekiyor. üé§", "error");
    }
  });

  // Ses kaydƒ±nƒ± durdurma
  stopButton.addEventListener('click', function() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      recordButton.disabled = false;
      stopButton.style.display = 'none';
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      showToast("Ses kaydƒ± tamamlandƒ±. üé∂", "success");
    }
  });

  // Form g√∂nderimi
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const activeType = document.querySelector('.input-selector .active').dataset.type;
    const name = document.getElementById('name').value.trim();
    const message = document.getElementById('message').value.trim();
    const audioData = audioDataInput.value;

    // ƒ∞sim doƒürulama
    if (!name) { 
      showToast("L√ºtfen isminizi yazƒ±n ki anƒ±nƒ±zƒ± kime saklayacaƒüƒ±mƒ±zƒ± bilelim. üòä", "error"); 
      return; 
    }
    
    if (!isValidName(name)) {
      showToast("L√ºtfen ge√ßerli bir isim girin. Sadece √∂zel karakterler i√ßeren isimler kabul edilemez. ‚ùå", "error");
      return;
    }
    
    if (activeType === 'text' && !message) { 
      showToast("Anƒ± defterimiz i√ßin g√ºzel bir mesaj yazmanƒ±zƒ± rica ediyoruz. üíå", "error"); 
      return; 
    }
    
    if (activeType === 'audio' && !audioData) { 
      showToast("L√ºtfen bizim i√ßin g√ºzel bir ses kaydƒ± yapƒ±n. üé§", "error"); 
      return; 
    }
    
    if (activeType === 'image' && base64Images.length === 0) { 
      showToast("En az bir fotoƒüraf se√ßerek anƒ±larƒ±mƒ±za renk katƒ±n. üì∏", "error"); 
      return; 
    }
    
    if (activeType === 'video' && base64Videos.length === 0) { 
      showToast("Bir video se√ßerek anƒ±larƒ±mƒ±zƒ± hareketlendirin. üé¨", "error"); 
      return; 
    }

    const formData = new FormData();
    formData.append('key', API_KEY);
    formData.append('name', name);
    formData.append('type', activeType);
    formData.append('ip', clientIP);

    if (activeType === 'text') formData.append('message', message);
    else if (activeType === 'audio') formData.append('file', audioData);
    else if (activeType === 'image') formData.append('files', JSON.stringify(base64Images));
    else if (activeType === 'video') formData.append('files', JSON.stringify(base64Videos));

    loader.style.display = 'block';
    submitButton.disabled = true;
    hideStatus();

    try {
      const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const result = await response.json();

      if (result.success) {
        showToast("Anƒ±nƒ±z ba≈üarƒ±yla kaydedildi! Bizimle payla≈ütƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz. üíñ", "success");
        form.reset();
        audioPreview.style.display = 'none';
        imagePreview.innerHTML = '';
        videoPreview.innerHTML = '';
        imageSelectionInfo.style.display = 'none';
        selectorButtons.forEach(btn => btn.classList.remove('active'));
        selectorButtons[0].classList.add('active');
        textInputGroup.style.display = 'block';
        audioInputGroup.style.display = 'none';
        imageInputGroup.style.display = 'none';
        videoInputGroup.style.display = 'none';

        base64Images = [];
        base64Videos = [];
        selectedFiles = [];
        totalImageSize = 0;
        audioDataInput.value = "";
      } else {
        showToast("Bir ≈üeyler ters gitti. L√ºtfen daha sonra tekrar deneyin. üòî", "error");
      }
    } catch (error) {
      showToast("Baƒülantƒ± hatasƒ± olu≈ütu. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin. üåê", "error");
      console.error('Error:', error);
    } finally {
      loader.style.display = 'none';
      submitButton.disabled = false;
    }
  });

  function showStatus(message, type) {
    statusMessage.textContent = message;
    statusMessage.className = type;
    statusMessage.style.display = 'block';
    setTimeout(hideStatus, 5000);
  }

  function hideStatus() {
    statusMessage.style.display = 'none';
    statusMessage.textContent = '';
  }
});